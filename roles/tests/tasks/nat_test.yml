---  
  - name: Setup VPC network
    otc_vpc:
      state: "present"
      auth_type: password
      auth:
        "{{ otc_os_auth }}"
      cacert: "{{ otc_cert_file }}"
      validate_certs: "yes"
      name: "{{ net_admin.vpc.name }}"
      cidr: "10.19.0.0/16"
    register: vpc_result
  - set_fact: 
      net_admin_facts:
        vpc: "{{ vpc_result.vpc }}"
    when: net_admin_state == 'present'

  - name: Setup subnet access
    otc_subnet:
      state: "present"
      auth_type: password
      auth:
        "{{ otc_os_auth }}"
      cacert: "{{ otc_cert_file }}"
      validate_certs: "yes"
      name: "{{ net_admin.subnets.access.name }}" 
      vpc_id: "{{ net_admin_facts.vpc.id }}"
      cidr: "{{ net_admin.subnets.access.cidr }}"
      gateway_ip: "{{ net_admin.subnets.access.gateway_ip | default(net_admin.subnets.access.cidr|ipaddr('1')|ipaddr('address')) }}"
      dns_nameservers: "{{ net_admin.subnets.access.nameservers }}"
    register: sn_access_result
  - set_fact:
      net_admin_facts: "{{ net_admin_facts | combine({ 'subnets': { 'access': sn_access_result.subnet }}, recursive=True) }}"
    when: net_admin_state == 'present'

  - name: Aquire an external EIP
    otc_eip:
      state: "present"
      auth_type: password
      auth:
        "{{ otc_os_auth }}"
      cacert: "{{ otc_cert_file }}"
      validate_certs: "yes"
    register: snat_rule_eip

  - otc_nat:
      state: "present"
      auth_type: password
      auth:
        "{{ otc_os_auth }}"
      cacert: "{{ otc_cert_file }}"
      validate_certs: "yes"
      name: "rbe-sdktest-nat"
      description: "Some ansible test nat"
      vpc_id: "{{ net_admin_facts.vpc.id }}"
      subnet_id: "{{ net_admin_facts.subnets.access.id }}"
      spec: "1"
    register: nat_result
  - set_fact: 
      net_admin_facts: "{{ net_admin_facts | combine({ 'nat': nat_result.nat }, recursive=True) }}"

  - otc_nat_snatrule:
      state: "present"
      auth_type: password
      auth:
        "{{ otc_os_auth }}"
      cacert: "{{ otc_cert_file }}"
      validate_certs: "yes"
      nat_gateway_id: "{{ nat_result.id }}"
      subnet_id: "{{ net_admin_facts.subnets.access.id }}"
      eip_id: "{{ snat_rule_eip.id }}"
    register: snat_rule1
  - set_fact: 
      net_admin_facts: "{{ net_admin_facts | combine({ 'nat': { 'rules': snat_rule1 } }, recursive=True) }}"

  - otc_nat_snatrule:
      state: "absent"
      auth_type: password
      auth:
        "{{ otc_os_auth }}"
      cacert: "{{ otc_cert_file }}"
      validate_certs: "yes"
      nat_gateway_id: "{{ nat_result.id }}"
      subnet_id: "{{ net_admin_facts.subnets.access.id }}"

  - otc_nat:
      state: "absent"
      auth_type: password
      auth:
        "{{ otc_os_auth }}"
      cacert: "{{ otc_cert_file }}"
      validate_certs: "yes"
      name: "rbe-sdktest-nat"

  - name: Remove networks
    otc_subnet:
      state: "absent"
      auth_type: password
      auth:
        "{{ otc_os_auth }}"
      cacert: "{{ otc_cert_file }}"
      validate_certs: "yes"
      name: "{{ net_admin.subnets.access.name }}" 

  - otc_vpc:
      state: "absent"
      auth_type: password
      auth:
        "{{ otc_os_auth }}"
      cacert: "{{ otc_cert_file }}"
      validate_certs: "yes"
      name: "{{ net_admin.vpc.name }}"
